services:
  # ===== WEB SERVER (FREE - com limitações) =====
  - type: web
    name: twenty-server
    runtime: image
    image:
      url: twentycrm/twenty:latest
    dockerCommand: >
      sh -c "node /app/node_modules/typeorm/cli.js migration:run -d /app/packages/twenty-server/dist/src/database/typeorm/core/core.datasource.js && node /app/packages/twenty-server/dist/src/main"
    autoDeploy: true
    plan: free  # ✅ GRÁTIS! (mas dorme após 15 min)

    envVars:
      # ===== URLs Base (auto-preenchido) =====
      - key: FRONT_BASE_URL
        fromService:
          name: twenty-server
          type: web
          envVarKey: RENDER_EXTERNAL_URL

      - key: SERVER_URL
        fromService:
          name: twenty-server
          type: web
          envVarKey: RENDER_EXTERNAL_URL

      # ===== Segurança =====
      - key: APP_SECRET
        generateValue: true

      - key: NODE_ENV
        value: production

      # Define porta explicitamente para evitar timeout
      - key: PORT
        value: "3000"

      # Limita memória do Node para não estourar os 512MB do plano Free
      - key: NODE_OPTIONS
        value: "--max-old-space-size=460"

      # ===== Database Postgres (conecta ao FREE) =====
      - key: PG_DATABASE_URL
        fromDatabase:
          name: twenty-postgres
          property: connectionString

      # ===== Redis (Nativo do Render - FREE) =====
      - key: REDIS_URL
        fromService:
          name: twenty-redis
          type: keyvalue
          property: connectionString

      # ===== Multi-Workspace (ESSENCIAL para SaaS) =====
      - key: IS_MULTIWORKSPACE_ENABLED
        value: "true"

      # Desativa migração automática do entrypoint (que usa muita RAM)
      - key: DISABLE_DB_MIGRATIONS
        value: "true"

      - key: DEFAULT_SUBDOMAIN
        value: "app"

      # ===== Email SMTP (você preenche no dashboard) =====
      - key: EMAIL_DRIVER
        value: "SMTP"

      - key: EMAIL_SMTP_HOST
        sync: false  # Preencha: smtp.sendgrid.net

      - key: EMAIL_SMTP_PORT
        value: "587"

      - key: EMAIL_SMTP_USER
        sync: false  # Preencha: apikey

      - key: EMAIL_SMTP_PASSWORD
        sync: false  # Preencha: SG.xxx

      - key: EMAIL_FROM_ADDRESS
        value: "noreply@elloai.com.br"

      - key: EMAIL_FROM_NAME
        value: "Equipe ELLOAI"

      # ===== Storage S3-Compatible =====
      - key: STORAGE_TYPE
        value: "S3"

      # Para Cloudflare R2, use "auto"
      # Para AWS S3, use "us-east-1" ou sua região
      - key: STORAGE_S3_REGION
        value: "auto"

      - key: STORAGE_S3_NAME
        sync: false  # Nome do bucket

      # Para R2: https://xxx.r2.cloudflarestorage.com
      # Para Spaces: https://nyc3.digitaloceanspaces.com
      # Para AWS S3: deixe vazio ou https://s3.amazonaws.com
      - key: STORAGE_S3_ENDPOINT
        sync: false

      - key: STORAGE_S3_ACCESS_KEY_ID
        sync: false

      - key: STORAGE_S3_SECRET_ACCESS_KEY
        sync: false

      # ===== Billing / Stripe =====
      - key: IS_BILLING_ENABLED
        value: "true"

      - key: BILLING_STRIPE_API_KEY
        sync: false

      - key: BILLING_STRIPE_WEBHOOK_SECRET
        sync: false

      - key: BILLING_PLAN_REQUIRED_LINK
        sync: false  # Ex: https://seusite.com/pricing

      # ===== IA (Opcional) =====
      - key: OPENAI_API_KEY
        sync: false

      - key: ANTHROPIC_API_KEY
        sync: false

      - key: XAI_API_KEY
        sync: false

      # ===== Configurações de Segurança =====
      - key: AUTH_PASSWORD_ENABLED
        value: "true"

      # Desative se não tiver SMTP configurado ainda
      - key: IS_EMAIL_VERIFICATION_REQUIRED
        value: "false"

      # ===== Limites de Workspace (opcional) =====
      - key: IS_WORKSPACE_CREATION_LIMITED_TO_SERVER_ADMINS
        value: "false"  # true = só admins podem criar workspaces
      -
  # ===== REDIS SERVICE (Key Value) =====
  # Adicionado na seção SERVICES, não databases!
  - type: keyvalue
    name: twenty-redis
    plan: free
    ipAllowList: [] # Acessível apenas internamente por padrão

# ===== DATABASES =====
databases:
  # Postgres FREE (256MB RAM, 1GB storage)
  - name: twenty-postgres
    databaseName: twenty
    plan: free
    # ⚠️ IMPORTANTE: FREE expira em 90 dias se não usar!
    # Upgrade para "starter" ($7/mês) quando tiver clientes
    ipAllowList: []  # Permite conexões de qualquer IP

# ===== REDIS NATIVO =====
# Configurado como serviço KeyValue FREE
# ⚠️ Sem persistência (dados somem ao reiniciar)
# Para produção com persistência, use Upstash ou plano pago


# ===== NOTAS IMPORTANTES =====
#
# 1. WORKER REMOVIDO
#    - Não incluí o worker porque plano FREE dele custa $7/mês
#    - Para começar, você não precisa dele
#    - Adicione quando tiver clientes e precisar de jobs em background
#
# 2. WEB SERVICE FREE
#    - ✅ GRÁTIS mas com limitações:
#    - ❌ Dorme após 15 min sem uso
#    - ❌ Primeiro acesso demora ~30s (cold start)
#    - ✅ Bom para: Testes, desenvolvimento, validação
#    - ⚠️ Para produção: Upgrade para "starter" ($7/mês)
#
# 3. POSTGRES FREE
#    - ✅ 1GB storage (suficiente para começar)
#    - ❌ Expira em 90 dias se não usar
#    - ⚠️ Faça backup regularmente!
#    - ⚠️ Para produção: Upgrade para "starter" ($7/mês)
#
# 4. REDIS FREE
#    - ✅ 25MB RAM (OK para cache básico)
#    - ❌ SEM persistência (dados se perdem)
#    - ⚠️ Para produção: Use Upstash ($10/mês com persistência)
#
# 5. CUSTOS TOTAIS
#    - Inicial (FREE): $0/mês ✅
#    - Com clientes (STARTER): ~$14/mês
#    - Produção real (STARTER + Upstash): ~$24/mês
#
# 6. STORAGE S3
#    - Recomendado: Cloudflare R2 (10GB grátis/mês)
#    - Alternativa: DigitalOcean Spaces ($5/mês)
#    - AWS S3: Mais caro, use só se preciso
#
# 7. EMAIL SMTP
#    - Recomendado: SendGrid (100 emails/dia grátis)
#    - Alternativa: Mailgun (5k emails/mês grátis)
#
# ===== COMO PREENCHER AS VARIÁVEIS =====
#
# Após criar o blueprint no Render:
# 1. Vá em "Environment" no dashboard
# 2. Preencha as variáveis com "sync: false":
#    - EMAIL_SMTP_HOST
#    - EMAIL_SMTP_USER
#    - EMAIL_SMTP_PASSWORD
#    - STORAGE_S3_NAME
#    - STORAGE_S3_ENDPOINT
#    - STORAGE_S3_ACCESS_KEY_ID
#    - STORAGE_S3_SECRET_ACCESS_KEY
#    - BILLING_STRIPE_API_KEY
#    - BILLING_STRIPE_WEBHOOK_SECRET
#    - BILLING_PLAN_REQUIRED_LINK
#    - (Opcional) OPENAI_API_KEY, etc.
#
# ===== PRÓXIMOS PASSOS =====
#
# 1. Configurar Cloudflare R2 (grátis)
# 2. Configurar SendGrid (grátis)
# 3. Fazer deploy usando este render.yaml
# 4. Testar tudo
# 5. Quando tiver primeiros clientes: upgrade para STARTER
